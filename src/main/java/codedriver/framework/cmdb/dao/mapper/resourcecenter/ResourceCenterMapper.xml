<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright(c) 2021 TechSureCo.,Ltd.AllRightsReserved.
  ~ 本内容仅限于深圳市赞悦科技有限公司内部传阅，禁止外泄以及用于其他的商业项目。
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codedriver.framework.cmdb.dao.mapper.resourcecenter.ResourceCenterMapper">

    <sql id="resource_ipobject_from_join">
        FROM ${schemaName}.`resource_ipobject` a
        LEFT JOIN ${schemaName}.`resource_ipobject_bg` b ON b.`resource_id` = a.`id`
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_ip` c ON c.`resource_id` = a.`id` -->
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_netarea` d ON d.`resource_id` = a.`id` -->
        LEFT JOIN ${schemaName}.`resource_ipobject_owner` e ON e.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_state` f ON f.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_datacenter` g ON g.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_softwareservice_env` h ON h.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i ON i.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_appsystem_appmodule` j ON j.`app_module_id` = i.`app_module_id`
        LEFT JOIN ${schemaName}.`resource_appsystem` l ON l.`id` = j.`resource_id`
        LEFT JOIN ${schemaName}.`resource_softwareservice` m ON m.`id` = a.`id`
    </sql>
    <sql id="resource_ipobject_where">
        <where>
            <if test="keyword != null and keyword != ''">
                AND (a.`name` LIKE CONCAT('%', #{keyword}, '%') OR a.`ip` LIKE CONCAT('%', #{keyword}, '%') OR m.`port`
                LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="typeIdList != null and typeIdList.size() > 0">
                AND a.`type_id` IN
                <foreach collection="typeIdList" item="typeId" open="(" separator="," close=")">
                    #{typeId}
                </foreach>
            </if>
            <if test="stateIdList != null and stateIdList.size() > 0">
                AND f.`state_id` IN
                <foreach collection="stateIdList" item="stateId" open="(" separator="," close=")">
                    #{stateId}
                </foreach>
            </if>
            <if test="envIdList != null and envIdList.size() > 0">
                AND h.`env_id` IN
                <foreach collection="envIdList" item="envId" open="(" separator="," close=")">
                    #{envId}
                </foreach>
            </if>
            <if test="appSystemIdList != null and appSystemIdList.size() > 0">
                AND l.`id` IN
                <foreach collection="appSystemIdList" item="appSystemId" open="(" separator="," close=")">
                    #{appSystemId}
                </foreach>
            </if>
            <if test="appModuleIdList != null and appModuleIdList.size() > 0">
                AND i.`app_module_id` IN
                <foreach collection="appModuleIdList" item="appModuleId" open="(" separator="," close=")">
                    #{appModuleId}
                </foreach>
            </if>
            <if test="idList != null and idList.size() > 0">
                AND a.`id` IN
                <foreach collection="idList" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
        </where>
    </sql>
    <select id="getResourceCount" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        <include refid="resource_ipobject_from_join"/>
        <include refid="resource_ipobject_where"/>
    </select>

    <select id="getResourceIdList" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="java.lang.Long">
        SELECT DISTINCT a.`id`
        <include refid="resource_ipobject_from_join"/>
        <include refid="resource_ipobject_where"/>
        LIMIT #{startNum}, #{pageSize}
    </select>

    <resultMap id="resourceCenterMap" type="codedriver.framework.cmdb.dto.resourcecenter.ResourceVo">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="abbr_name" property="abbrName"/>
        <result column="type_id" property="typeId"/>
        <result column="type_name" property="typeName"/>
        <result column="type_label" property="typeLabel"/>
        <result column="maintenance_window" property="maintenanceWindow"/>
        <result column="description" property="description"/>
        <result column="network_area" property="networkArea"/>
        <result column="port" property="port"/>
        <result column="ip_id" property="ipId"/>
        <result column="ip" property="ip"/>
        <!-- <result column="netarea_id" property="netAreaId"/> -->
        <!-- <result column="netarea_name" property="netAreaName"/> -->
        <result column="state_id" property="stateId"/>
        <result column="state_name" property="stateName"/>
        <result column="datacenter_id" property="dataCenterId"/>
        <result column="datacenter_name" property="dataCenterName"/>
        <result column="env_id" property="envId"/>
        <result column="env_name" property="envName"/>
        <result column="app_module_id" property="appModuleId"/>
        <result column="app_module_name" property="appModuleName"/>
        <result column="app_system_id" property="appSystemId"/>
        <result column="app_system_name" property="appSystemName"/>
        <result column="app_system_abbr_name" property="appSystemAbbrName"/>
        <result column="cluster_id" property="clusterId"/>
        <result column="cluster_name" property="clusterName"/>
        <result column="cluster_type_id" property="clusterTypeId"/>
        <collection property="bgList" ofType="codedriver.framework.cmdb.dto.resourcecenter.BgVo">
            <id column="bg_id" property="bgId"/>
            <result column="bg_name" property="bgName"/>
        </collection>
        <collection property="ownerList" ofType="codedriver.framework.cmdb.dto.resourcecenter.OwnerVo">
            <id column="user_id" property="userId"/>
            <result column="user_uuid" property="uuid"/>
            <result column="user_name" property="userName"/>
        </collection>
    </resultMap>

    <select id="getResourceListByIdList" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, a.`type_id`, a.`type_name`, a.`type_label`, a.`maintenance_window`, a.`description`,
        a.`network_area`, a.`ip`,
        b.`bg_id`, b.`bg_name`,
        <!-- c.`ip_id`, c.`ip`, -->
        <!-- d.`netarea_id`, d.`netarea_name`, -->
        e.`user_id`, e.`user_name`, e.`user_uuid`,
        f.`state_id`, f.`state_name`,
        g.`datacenter_id`, g.`datacenter_name`,
        h.`env_id`, h.`env_name`,
        i.`app_module_id`, i.`app_module_name`,
        l.`id` AS `app_system_id`, l.`name` AS app_system_name, l.`abbr_name` AS app_system_abbr_name,
        m.`port`
        <include refid="resource_ipobject_from_join"/>
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getOsResourceCount" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        FROM ${schemaName}.`resource_os` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
    </select>

    <select id="getOsResourceIdList" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="java.lang.Long">
        SELECT DISTINCT a.`id`
        FROM ${schemaName}.`resource_os` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="getOsResourceListByIdList" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, a.`type_id`, a.`type_name`, a.`type_label`, a.`maintenance_window`, a.`description`,
        a.`network_area`, a.`ip`,
        b.`bg_id`, b.`bg_name`,
        <!-- c.`ip_id`, c.`ip`, -->
        <!-- d.`netarea_id`, d.`netarea_name`, -->
        e.`user_id`, e.`user_name`, e.`user_uuid`,
        f.`state_id`, f.`state_name`,
        g.`datacenter_id`, g.`datacenter_name`,
        h.`env_id`, h.`env_name`,
        n.`cluster_id`,
        n.`cluster_type_id`,
        n.`cluster_name`
        FROM ${schemaName}.`resource_os` a
        LEFT JOIN ${schemaName}.`resource_ipobject_bg` b ON b.`resource_id` = a.`id`
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_ip` c ON c.`resource_id` = a.`id` -->
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_netarea` d ON d.`resource_id` = a.`id` -->
        LEFT JOIN ${schemaName}.`resource_ipobject_owner` e ON e.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_state` f ON f.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_datacenter` g on g.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_os_oscluster` n ON n.`resource_id` = a.`id`
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getStorageResourceCount" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        FROM ${schemaName}.`resource_storage` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
    </select>

    <select id="getStorageResourceIdList" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="java.lang.Long">
        SELECT DISTINCT a.`id`
        FROM ${schemaName}.`resource_storage` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="getStorageResourceListByIdList" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, a.`type_id`, a.`type_name`, a.`type_label`, a.`maintenance_window`, a.`description`,
        a.`network_area`, a.`ip`,
        b.`bg_id`, b.`bg_name`,
        <!-- c.`ip_id`, c.`ip`, -->
        <!-- d.`netarea_id`, d.`netarea_name`, -->
        e.`user_id`, e.`user_name`, e.`user_uuid`,
        f.`state_id`, f.`state_name`,
        g.`datacenter_id`, g.`datacenter_name`,
        h.`env_id`, h.`env_name`
        FROM ${schemaName}.`resource_storage` a
        LEFT JOIN ${schemaName}.`resource_ipobject_bg` b ON b.`resource_id` = a.`id`
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_ip` c ON c.`resource_id` = a.`id` -->
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_netarea` d ON d.`resource_id` = a.`id` -->
        LEFT JOIN ${schemaName}.`resource_ipobject_owner` e ON e.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_state` f ON f.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_datacenter` g on g.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getNetDevResourceCount" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        FROM ${schemaName}.`resource_netdev` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
    </select>

    <select id="getNetDevResourceIdList" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="java.lang.Long">
        SELECT DISTINCT a.`id`
        FROM ${schemaName}.`resource_netdev` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="getNetDevResourceListByIdList" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, a.`type_id`, a.`type_name`, a.`type_label`, a.`maintenance_window`, a.`description`,
        a.`network_area`, a.`ip`,
        b.`bg_id`, b.`bg_name`,
        <!-- c.`ip_id`, c.`ip`, -->
        <!-- d.`netarea_id`, d.`netarea_name`, -->
        e.`user_id`, e.`user_name`, e.`user_uuid`,
        f.`state_id`, f.`state_name`,
        g.`datacenter_id`, g.`datacenter_name`,
        h.`env_id`, h.`env_name`
        FROM ${schemaName}.`resource_netdev` a
        LEFT JOIN ${schemaName}.`resource_ipobject_bg` b ON b.`resource_id` = a.`id`
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_ip` c ON c.`resource_id` = a.`id` -->
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_netarea` d ON d.`resource_id` = a.`id` -->
        LEFT JOIN ${schemaName}.`resource_ipobject_owner` e ON e.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_state` f ON f.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_datacenter` g on g.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getAppInstanceResourceCount"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        FROM ${schemaName}.`resource_appinstance` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
    </select>

    <select id="getAppInstanceResourceIdList"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="java.lang.Long">
        SELECT DISTINCT a.`id`
        FROM ${schemaName}.`resource_appinstance` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="getAppInstanceResourceListByIdList" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, a.`type_id`, a.`type_name`, a.`type_label`, a.`maintenance_window`, a.`description`,
        a.`network_area`, a.`ip`,
        b.`bg_id`, b.`bg_name`,
        <!-- c.`ip_id`, c.`ip`, -->
        <!-- d.`netarea_id`, d.`netarea_name`, -->
        e.`user_id`, e.`user_name`, e.`user_uuid`,
        f.`state_id`, f.`state_name`,
        g.`datacenter_id`, g.`datacenter_name`,
        h.`env_id`, h.`env_name`,
        m.`port`,
        n.`cluster_id`,
        n.`cluster_type_id`,
        n.`cluster_name`
        FROM ${schemaName}.`resource_appinstance` a
        LEFT JOIN ${schemaName}.`resource_ipobject_bg` b ON b.`resource_id` = a.`id`
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_ip` c ON c.`resource_id` = a.`id` -->
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_netarea` d ON d.`resource_id` = a.`id` -->
        LEFT JOIN ${schemaName}.`resource_ipobject_owner` e ON e.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_state` f ON f.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_datacenter` g on g.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_softwareservice` m ON m.`id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_appinstance_appinstancecluster` n ON n.`resource_id` = a.`id`
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getDbInstanceResourceCount"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        FROM ${schemaName}.`resource_dbinstance` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
    </select>

    <select id="getDbInstanceResourceIdList"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="java.lang.Long">
        SELECT DISTINCT a.`id`
        FROM ${schemaName}.`resource_dbinstance` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="getDbInstanceResourceListByIdList" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, a.`type_id`, a.`type_name`, a.`type_label`, a.`maintenance_window`, a.`description`,
        a.`network_area`, a.`ip`,
        b.`bg_id`, b.`bg_name`,
        <!-- c.`ip_id`, c.`ip`, -->
        <!-- d.`netarea_id`, d.`netarea_name`, -->
        e.`user_id`, e.`user_name`, e.`user_uuid`,
        f.`state_id`, f.`state_name`,
        g.`datacenter_id`, g.`datacenter_name`,
        h.`env_id`, h.`env_name`,
        m.`port`,
        n.`cluster_id`,
        n.`cluster_type_id`,
        n.`cluster_name`
        FROM ${schemaName}.`resource_dbinstance` a
        LEFT JOIN ${schemaName}.`resource_ipobject_bg` b ON b.`resource_id` = a.`id`
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_ip` c ON c.`resource_id` = a.`id` -->
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_netarea` d ON d.`resource_id` = a.`id` -->
        LEFT JOIN ${schemaName}.`resource_ipobject_owner` e ON e.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_state` f ON f.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_datacenter` g on g.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_softwareservice` m ON m.`id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_dbinstance_dbcluster` n ON n.`resource_id` = a.`id`
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getAppInstanceClusterResourceCount"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        FROM ${schemaName}.`resource_appinstance_cluster` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
    </select>

    <select id="getAppInstanceClusterResourceIdList"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="java.lang.Long">
        SELECT DISTINCT a.`id`
        FROM ${schemaName}.`resource_appinstance_cluster` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="getAppInstanceClusterResourceListByIdList" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, a.`type_id`, a.`type_name`, a.`type_label`, a.`maintenance_window`, a.`description`,
        a.`network_area`, a.`ip`,
        b.`bg_id`, b.`bg_name`,
        <!-- c.`ip_id`, c.`ip`, -->
        <!-- d.`netarea_id`, d.`netarea_name`, -->
        e.`user_id`, e.`user_name`, e.`user_uuid`,
        f.`state_id`, f.`state_name`,
        g.`datacenter_id`, g.`datacenter_name`,
        h.`env_id`, h.`env_name`,
        m.`port`
        FROM ${schemaName}.`resource_appinstance_cluster` a
        LEFT JOIN ${schemaName}.`resource_ipobject_bg` b ON b.`resource_id` = a.`id`
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_ip` c ON c.`resource_id` = a.`id` -->
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_netarea` d ON d.`resource_id` = a.`id` -->
        LEFT JOIN ${schemaName}.`resource_ipobject_owner` e ON e.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_state` f ON f.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_datacenter` g on g.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_softwareservice` m ON m.`id` = a.`id`
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getDbInstanceClusterResourceCount"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        FROM ${schemaName}.`resource_db_cluster` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
    </select>

    <select id="getDbInstanceClusterResourceIdList"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="java.lang.Long">
        SELECT DISTINCT a.`id`
        FROM ${schemaName}.`resource_db_cluster` a
                 LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
                 LEFT JOIN ${schemaName}.`resource_ipobject_appmodule` i on i.`resource_id` = a.`id`
        WHERE a.`type_id` = #{typeId}
          AND h.`env_id` = #{envId}
          AND i.`app_module_id` = #{appModuleId}
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="getDbInstanceClusterResourceListByIdList" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, a.`type_id`, a.`type_name`, a.`type_label`, a.`maintenance_window`, a.`description`,
        a.`network_area`, a.`ip`,
        b.`bg_id`, b.`bg_name`,
        <!-- c.`ip_id`, c.`ip`, -->
        <!-- d.`netarea_id`, d.`netarea_name`, -->
        e.`user_id`, e.`user_name`, e.`user_uuid`,
        f.`state_id`, f.`state_name`,
        g.`datacenter_id`, g.`datacenter_name`,
        h.`env_id`, h.`env_name`,
        m.`port`
        FROM ${schemaName}.`resource_db_cluster` a
        LEFT JOIN ${schemaName}.`resource_ipobject_bg` b ON b.`resource_id` = a.`id`
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_ip` c ON c.`resource_id` = a.`id` -->
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_netarea` d ON d.`resource_id` = a.`id` -->
        LEFT JOIN ${schemaName}.`resource_ipobject_owner` e ON e.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_state` f ON f.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_ipobject_datacenter` g on g.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_softwareservice_env` h on h.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_softwareservice` m ON m.`id` = a.`id`
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getResourceIdByIpAndPortAndName"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="java.lang.Long">
        SELECT a.`id`
        FROM ${schemaName}.`resource_ipobject` a
        LEFT JOIN ${schemaName}.`resource_softwareservice` b on b.`id` = a.`id`
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_ip` c on c.`resource_id` = a.`id` -->
        WHERE a.`ip` = #{ip}
        <if test="port != null and port != ''">
            AND b.`port` = #{port}
        </if>
        <if test="name != null and name != ''">
            and a.`name` = #{name}
        </if>
        LIMIT 1
    </select>
    <select id="getResourceIpPortById" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, b.`port`, a.`ip`
        FROM ${schemaName}.`resource_ipobject` a
        LEFT JOIN ${schemaName}.`resource_softwareservice` b on b.`id` = a.`id`
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_ip` c on c.`resource_id` = a.`id` -->
        where a.`id` = #{id}
        LIMIT 1
    </select>

    <select id="getResourceByIdList" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, a.`ip`
        FROM ${schemaName}.`resource_ipobject` a
        where a.`id` in
        <foreach collection="idList" item="id" separator="," close=")" open="(">
            #{id}
        </foreach>
    </select>

    <select id="checkResourceIsExists" resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        FROM ${schemaName}.`resource_ipobject` a
        where a.`id` = #{id}
    </select>

    <select id="checkResourceIdListIsExists" resultType="java.lang.Long">
        SELECT a.`id`
        FROM ${schemaName}.`resource_ipobject` a
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getTagListByResourceId" parameterType="java.lang.Long"
            resultType="codedriver.framework.cmdb.dto.tag.TagVo">
        SELECT a.`id`, a.`name`
        FROM `cmdb_tag` a
                 JOIN `cmdb_resourcecenter_resource_tag` b ON b.`tag_id` = a.`id` AND b.`resource_id` = #{value}
    </select>

    <select id="getAccountCount" parameterType="codedriver.framework.cmdb.dto.resourcecenter.AccountVo"
            resultType="int">
        SELECT COUNT(1) FROM `cmdb_resourcecenter_account`
        <where>
            <if test="keyword != null and keyword != ''">
                `name` like concat('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <select id="getAccountById" parameterType="java.lang.Long"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.AccountVo">
        select a.`id`,
               a.`name`,
               a.`account`,
               a.`password` as passwordCipher,
               b.name       as protocol,
               b.id         as protocolId,
               b.`port`     as protocolPort,
               a.`fcu`,
               a.`fcd`,
               a.`lcu`,
               a.`lcd`
        from `cmdb_resourcecenter_account` a
                 JOIN `cmdb_resourcecenter_account_protocol` b ON a.`protocol_id` = b.`id`
        where a.`id` = #{value}
    </select>

    <select id="getAccountListByIdList" parameterType="java.lang.Long"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.AccountVo">
        SELECT
        a.`id`,
        a.`name`,
        a.`account`,
        a.`password` as passwordCipher,
        b.name as protocol,
        b.`port`,
        a.`fcu`,
        a.`fcd`,
        a. `lcu`,
        a.`lcd`
        FROM `cmdb_resourcecenter_account` a JOIN `cmdb_resourcecenter_account_protocol` b ON a.`protocol_id`=b.`id`
        WHERE a.`id` IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="checkAccountNameIsRepeats" parameterType="codedriver.framework.cmdb.dto.resourcecenter.AccountVo"
            resultType="int">
        SELECT COUNT(1)
        FROM `cmdb_resourcecenter_account`
        WHERE `name` = #{name}
          and `id` != #{id}
    </select>

    <select id="checkAccountHasBeenResourceReferredById" parameterType="java.lang.Long" resultType="int">
        select count(1)
        from `cmdb_resourcecenter_resource_account`
        where `account_id` = #{value}
    </select>

    <select id="searchAccountCount" parameterType="codedriver.framework.cmdb.dto.resourcecenter.AccountVo"
            resultType="int">
        SELECT COUNT(1) FROM `cmdb_resourcecenter_account` a JOIN `cmdb_resourcecenter_account_protocol` b ON
        b.`id`=a.`protocol_id`
        <where>
            <if test="keyword != null and keyword != ''">
                and a.`name` like concat('%', #{keyword}, '%')
            </if>
            <if test="protocolList != null and protocolList.size() > 0">
                and
                b.`name`
                in
                <foreach collection="protocolList" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <resultMap id="accountMap" type="codedriver.framework.cmdb.dto.resourcecenter.AccountVo">
        <result column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="account" property="account"/>
        <result column="password" property="passwordCipher"/>
        <result column="protocolId" property="protocolId"/>
        <result column="protocol" property="protocol"/>
        <result column="protocolPort" property="protocolPort"/>
        <result column="resourceReferredCount" property="resourceReferredCount"/>
        <result column="tagentReferredCount" property="tagentReferredCount"/>
        <result column="fcu" property="fcu"/>
        <result column="fcd" property="fcd"/>
        <result column="lcu" property="lcu"/>
        <result column="lcd" property="lcd"/>
    </resultMap>

    <select id="searchAccount" parameterType="codedriver.framework.cmdb.dto.resourcecenter.AccountVo"
            resultMap="accountMap">
        SELECT
        a.`id`,
        a.`name`,
        a.`account`,
        b.name as protocol,
        b.`port` as protocolPort,
        (select count(1) from `cmdb_resourcecenter_resource_account` where `account_id` = a.`id`) as
        resourceReferredCount,
        (select count(1) from `tagent` where `account_id` = a.`id`) as tagentReferredCount,
        a.`fcu`,
        a.`fcd`,
        a.`lcu`,
        a.`lcd`
        FROM `cmdb_resourcecenter_account` a JOIN `cmdb_resourcecenter_account_protocol` b ON b.`id`=a.`protocol_id`
        <where>
            <if test="keyword != null and keyword != ''">
                and a.`name` like concat('%', #{keyword}, '%')
            </if>
            <if test="protocolList != null and protocolList.size() > 0">
                and b.name in
                <foreach collection="protocolList" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="defaultValue != null and defaultValue.size() > 0">
                and a.`id` in
                <foreach collection="defaultValue" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        order by a.`lcd` desc
        <if test="needPage == true">
            limit #{startNum}, #{pageSize}
        </if>
    </select>

    <select id="getAccountListForSelect" parameterType="codedriver.framework.cmdb.dto.resourcecenter.AccountVo"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.AccountVo">
        SELECT `id`, `name` FROM `cmdb_resourcecenter_account`
        <where>
            <if test="keyword != null and keyword != ''">
                `name` like concat('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <select id="getTagCount" parameterType="codedriver.framework.cmdb.dto.tag.TagVo" resultType="int">
        SELECT COUNT(1) FROM `cmdb_tag`
        <where>
            <if test="keyword != null and keyword != ''">
                `name` like concat('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <select id="getTagListForSelect" parameterType="codedriver.framework.cmdb.dto.tag.TagVo"
            resultType="codedriver.framework.cmdb.dto.tag.TagVo">
        SELECT `id`, `name` FROM `cmdb_tag`
        <where>
            <if test="keyword != null and keyword != ''">
                and `name` like concat('%', #{keyword}, '%')
            </if>
            <if test="defaultValue != null and defaultValue.size() > 0">
                and `id` in
                <foreach collection="defaultValue" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="getTagNameListForSelect" parameterType="codedriver.framework.cmdb.dto.tag.TagVo"
            resultType="java.lang.String">
        SELECT `name` FROM `cmdb_tag`
        <where>
            <if test="keyword != null and keyword != ''">
                and `name` like concat('%', #{keyword}, '%')
            </if>
        </where>
        ORDER BY `name`
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="checkTagNameIsRepeats" parameterType="codedriver.framework.cmdb.dto.tag.TagVo" resultType="int">
        select count(1)
        from `cmdb_tag`
        where `name` = #{name}
          and `id` != #{id}
    </select>

    <select id="checkTagIsExistsById" parameterType="java.lang.Long" resultType="int">
        select count(1)
        from `cmdb_tag`
        where `id` = #{value}
    </select>

    <select id="searchTagCount" parameterType="codedriver.framework.cmdb.dto.tag.TagVo" resultType="int">
        select count(1)
        from `cmdb_tag`
        <where>
            <if test="keyword != null and keyword != ''">
                `name` like concat('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <select id="searchTag" parameterType="codedriver.framework.cmdb.dto.tag.TagVo"
            resultType="codedriver.framework.cmdb.dto.tag.TagVo">
        select
        `id`,
        `name`,
        `description`,
        (select count(1) from `cmdb_resourcecenter_resource_tag` where `tag_id` = `id`) as assetsCount
        from `cmdb_tag`
        <where>
            <if test="keyword != null and keyword != ''">
                `name` like concat('%', #{keyword}, '%')
            </if>
        </where>
        order by `id` desc
        <if test="needPage == true">
            limit #{startNum}, #{pageSize}
        </if>
    </select>

    <select id="getTagById" parameterType="java.lang.Long" resultType="codedriver.framework.cmdb.dto.tag.TagVo">
        select `id`, `name`, `description`
        from `cmdb_tag`
        where `id` = #{value}
    </select>

    <select id="checkTagHasBeenReferredById" parameterType="java.lang.Long" resultType="int">
        select count(1)
        from `cmdb_resourcecenter_resource_tag`
        where `tag_id` = #{value}
    </select>

    <select id="getAccountIdListByAccountAndProtocol" resultType="java.lang.Long">
        SELECT a.`id`
        FROM `cmdb_resourcecenter_account` a
                 JOIN `cmdb_resourcecenter_account_protocol` b ON b.`id` = a.`protocol_id`
        where a.`account` = #{account}
          and b.`name` = #{protocol}
    </select>

    <select id="getNoCorrespondingAccountResourceIdListByTagListAndAccountIdAndProtocol" resultType="java.lang.Long">
        SELECT a.`resource_id` FROM `cmdb_resourcecenter_resource_tag` a
        WHERE a.`tag_id` IN
        <foreach collection="tagList" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
        AND NOT EXISTS (
        SELECT b.`resource_id` FROM `cmdb_resourcecenter_resource_account` b
        JOIN `cmdb_resourcecenter_account` c on c.`id` = b.`account_id`
        JOIN `cmdb_resourcecenter_account_protocol` d ON d.`id`=c.`protocol_id`
        and c.`account` = #{account}
        and d.name = #{protocol}
        WHERE b.`resource_id` = a.`resource_id`
        )
    </select>

    <select id="checkResourceIsExistsCorrespondingAccountByResourceIdAndAccountIdAndProtocol"
            resultType="java.lang.Long">
        SELECT c.`id`
        FROM `cmdb_resourcecenter_resource_account` b
                 JOIN `cmdb_resourcecenter_account` c on c.`id` = b.`account_id` and c.`account` = #{account}
                 JOIN `cmdb_resourcecenter_account_protocol` d ON d.`id` = c.`protocol_id`
            and d.name = #{protocol}
        WHERE b.`resource_id` = #{resourceId}
        LIMIT 1
    </select>

    <select id="getAppModuleIdList" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="java.lang.Long">
        SELECT a.`id` FROM ${schemaName}.`resource_appmodule` a
        <where>
            <if test="keyword != null and keyword != ''">
                AND a.`name` LIKE concat('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <select id="getAppModuleListByIdList" parameterType="java.util.List" resultMap="resourceCenterMap">
        SELECT
        a.`id`, a.`name`, a.`abbr_name`, a.`maintenance_window`, a.`description`,
        b.`user_id`, b.`user_name`, b.`user_uuid`,
        c.`bg_id`, c.`bg_name`,
        e.`id` AS `app_system_id`, e.`name` AS app_system_name, e.`abbr_name` AS app_system_abbr_name
        FROM ${schemaName}.`resource_appmodule` a
        LEFT JOIN ${schemaName}.`resource_appmodule_owner` b ON b.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_appmodule_bg` c ON c.`resource_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_appsystem_appmodule` d on d.`app_module_id` = a.`id`
        LEFT JOIN ${schemaName}.`resource_appsystem` e on e.`id` = d.`resource_id`
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY a.`id` DESC
    </select>

    <select id="getAppSystemCount" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="int">
        SELECT COUNT(DISTINCT a.`id`) FROM ${schemaName}.`resource_appsystem` a
        <where>
            <if test="keyword != null and keyword != ''">
                AND a.`name` LIKE concat('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <select id="getAppSystemIdList" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="java.lang.Long">
        SELECT DISTINCT a.`id` FROM ${schemaName}.`resource_appsystem` a
        <where>
            <if test="keyword != null and keyword != ''">
                AND a.`name` LIKE concat('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <select id="getAppSystemListByIdList" parameterType="java.util.List" resultMap="resourceCenterMap">
        SELECT
        a.`id`, a.`name`, a.`abbr_name`, a.`maintenance_window`, a.`description`
        FROM ${schemaName}.`resource_appsystem` a
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="checkAppModuleIsExists" resultType="int">
        SELECT COUNT(1)
        FROM ${schemaName}.`resource_appmodule`
        WHERE `id` = #{id}
    </select>

    <select id="getEnvironmentListByAppModuleId"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.entity.AppEnviromentVo">
        SELECT DISTINCT a.`env_id` AS envId, a.`env_name` AS envName
        FROM ${schemaName}.`resource_softwareservice_env` a
        <if test="appModuleId != null">
            JOIN ${schemaName}.`resource_ipobject_appmodule` b ON b.`resource_id`=a.`resource_id` AND b.`app_module_id`
            = #{appModuleId}
        </if>
    </select>

    <select id="getResourceTypeListByAppModuleIdAndEnvId"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.ResourceTypeVo">
        SELECT DISTINCT a.`type_id`    AS id,
                        a.`type_name`  AS `name`,
                        a.`type_label` AS label
        FROM ${schemaName}.`resource_ipobject` a
                 JOIN ${schemaName}.`resource_softwareservice_env` b
                      ON b.`resource_id` = a.`id` AND b.`env_id` = #{envId}
                 JOIN ${schemaName}.`resource_ipobject_appmodule` c
                      ON c.`resource_id` = a.`id` AND c.`app_module_id` = #{appModuleId}
    </select>
    <select id="getResourceTypeList" parameterType="java.lang.String"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.ResourceTypeVo">
        SELECT DISTINCT a.`type_id`    AS id,
                        a.`type_name`  AS `name`,
                        a.`type_label` AS label
        FROM ${schemaName}.`resource_ipobject` a
    </select>

    <select id="getStateList" parameterType="java.lang.String"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.entity.StateVo">
        SELECT DISTINCT `state_id` AS stateId, `state_name` AS stateName
        FROM ${schemaName}.`resource_ipobject_state`
    </select>

    <select id="getResourceIdListByProtocolIdList"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="java.lang.Long">
        SELECT DISTINCT b.`resource_id`
        FROM `cmdb_resourcecenter_account` a
        JOIN `cmdb_resourcecenter_resource_account` b ON b.`account_id` = a.`id`
        JOIN `cmdb_resourcecenter_account_protocol` c ON c.`id`=a.`protocol_id`
        WHERE c.`id` IN
        <foreach collection="protocolIdList" item="protocolId" open="(" separator="," close=")">
            #{protocolId}
        </foreach>
    </select>

    <select id="getResourceIdListByTagIdList"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="java.lang.Long">
        SELECT DISTINCT a.`resource_id`
        FROM `cmdb_resourcecenter_resource_tag` a
        WHERE a.`tag_id` IN
        <foreach collection="tagIdList" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
    </select>

    <select id="checkAccountIdListIsExists" parameterType="java.util.List" resultType="java.lang.Long">
        SELECT `id`
        FROM `cmdb_resourcecenter_account`
        WHERE `id` IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getTagListByTagNameList" parameterType="java.util.List"
            resultType="codedriver.framework.cmdb.dto.tag.TagVo">
        SELECT
        `id`,
        `name`,
        `description`
        FROM `cmdb_tag`
        WHERE `name` IN
        <foreach collection="list" item="name" open="(" separator="," close=")">
            #{name}
        </foreach>
    </select>
    <select id="getTagListByIdList" parameterType="java.util.List" resultType="codedriver.framework.cmdb.dto.tag.TagVo">
        SELECT
        `id`,
        `name`,
        `description`
        FROM `cmdb_tag`
        WHERE `id` IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="checkTagIdExistsByTagIdList" parameterType="java.util.List" resultType="java.lang.Long">
        select `id` from `cmdb_tag`
        where `id` in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="getResourceAccountListByResourceIdList" parameterType="java.util.List"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.ResourceAccountVo">
        SELECT
        `resource_id` AS resourceId,
        `account_id` AS accountId
        FROM `cmdb_resourcecenter_resource_account`
        WHERE `resource_id` in
        <foreach collection="list" item="resourceId" open="(" separator="," close=")">
            #{resourceId}
        </foreach>
    </select>

    <select id="getResourceTagListByResourceIdList" parameterType="java.util.List"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.ResourceTagVo">
        SELECT
        `resource_id` AS resourceId,
        `tag_id` AS tagId
        FROM `cmdb_resourcecenter_resource_tag`
        WHERE `resource_id` in
        <foreach collection="list" item="resourceId" open="(" separator="," close=")">
            #{resourceId}
        </foreach>
    </select>

    <select id="getResourceListByResourceVoList" resultType="codedriver.framework.cmdb.dto.resourcecenter.ResourceVo">
        SELECT ri.name,ri.`ip`,ri.id,rs.port,ri.type_name as typeName
        FROM ${schemaName}.`resource_ipobject` ri
        <!-- LEFT JOIN ${schemaName}.`resource_ipobject_ip` rii ON ri.`id` = rii.`resource_id` -->
        LEFT JOIN ${schemaName}.`resource_softwareservice` rs ON ri.`id` = rs.`id`
        WHERE
        <foreach collection="resourceList" item="resource" separator="or" open="(" close=")">
            ri.ip = #{resource.ip}
            <if test="resource.port != null">
                and rs.port = #{resource.port}
            </if>
            <if test="resource.port == null">
                and rs.port is null
            </if>
        </foreach>
    </select>

    <select id="getResourceAccountListByResourceIdAndProtocolAndAccount"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.AccountVo">
        SELECT crap.name as protocol,cra.id,cra.`account` ,cra.`password` as passwordCipher,crra.`resource_id`
        resourceId,crap.port as protocolPort,cra.`protocol_id` as protocolId
        FROM `cmdb_resourcecenter_resource_account` crra
        LEFT JOIN `cmdb_resourcecenter_account` cra ON crra.`account_id` = cra.`id`
        LEFT JOIN `cmdb_resourcecenter_account_protocol` crap ON crap.`id`=cra.`protocol_id`
        WHERE crra.`resource_id` in
        <foreach collection="resourceIdList" item="resourceId" open="(" close=")" separator=",">
            #{resourceId}
        </foreach>
        AND crap.id = #{protocolId}
        <if test="userName != null">
            AND cra.`account` = #{userName}
        </if>
        <if test="userName == null">
            AND cra.`account` is null
        </if>

    </select>

    <select id="getAccountProtocolVoByProtocolId"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.AccountProtocolVo">
        select `id`, `name`
        from `cmdb_resourcecenter_account_protocol`
        where `id` = #{value}
    </select>

    <select id="searchTagListByIdList" parameterType="java.util.List"
            resultType="codedriver.framework.cmdb.dto.tag.TagVo">
        SELECT
        `id`,
        `name`,
        `description`
        FROM `cmdb_tag`
        WHERE `id` IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="searchAccountComponent" resultType="codedriver.framework.cmdb.dto.resourcecenter.AccountComponentVo">
        SELECT
        a.id as id,
        a.name as name,
        a.ip as ip,
        b.id as accountId,
        b.name as accountName,
        b.account as account,
        d.id as protocolId,
        d.name as protocol,
        d.port as port
        FROM `cmdb_resourcecenter_resource_account` c
        JOIN ${schemaName}.`resource_ipobject` a ON a.id = c.resource_id
        JOIN `cmdb_resourcecenter_account` b ON b.id = c.account_id
        JOIN `cmdb_resourcecenter_account_protocol` d ON d.id = b.protocol_id
        <!-- JOIN ${schemaName}.`resource_ipobject_ip` e ON e.resource_id = a.id -->
        <where>
            <if test="accountComponentVo.keyword != null and accountComponentVo.keyword != ''">
                a.`name` like concat('%', #{accountComponentVo.keyword}, '%') or a.`ip` =#{accountComponentVo.keyword}
            </if>
        </where>
        LIMIT #{accountComponentVo.startNum}, #{accountComponentVo.pageSize}
    </select>

    <select id="searchAccountComponentCount" resultType="int">
        SELECT
        count(DISTINCT a.id)
        FROM `cmdb_resourcecenter_resource_account` c
        JOIN ${schemaName}.`resource_ipobject` a ON a.id = c.resource_id
        JOIN `cmdb_resourcecenter_account` b ON b.id = c.account_id
        JOIN `cmdb_resourcecenter_account_protocol` d ON d.id = b.protocol_id
        <!-- JOIN ${schemaName}.`resource_ipobject_ip` e ON e.resource_id = a.id -->
        <where>
            <if test="accountComponentVo.keyword != null and accountComponentVo.keyword != ''">
                a.`name` like concat('%', #{accountComponentVo.keyword}, '%') or a.`ip` =#{accountComponentVo.keyword}
            </if>
        </where>
    </select>

    <select id="getAccountProtocolVoByProtocolName"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.AccountProtocolVo" parameterType="string">
        select `id`, `name`, `port`
        from `cmdb_resourcecenter_account_protocol`
        where `name` = #{value}
    </select>

    <select id="getAccountByName" parameterType="string" resultMap="accountMap">
        SELECT a.`id`,
               a.`name`,
               a.`account`,
               a.`protocol_id` as protocolId,
               a.`fcu`,
               a.`fcd`,
               a.`lcu`,
               a.`lcd`
        FROM `cmdb_resourcecenter_account` a
        where a.`name` = #{value}
    </select>
    <select id="getAccountListByIpList" resultType="codedriver.framework.cmdb.dto.resourcecenter.AccountVo">
        SELECT a.`id`,
        a.`name`,
        a.`account`,
        a.`protocol_id` AS protocolId,
        a.`password` as passwordCipher,
        crap.`name` as protocol,
        crap.`port` as protocolPort,
        a.`fcu`,
        a.`fcd`,
        a.`lcu`,
        crai.`ip`,
        a.`lcd`
        FROM `cmdb_resourcecenter_account` a
        left join `cmdb_resourcecenter_account_protocol` crap on a.protocol_id = crap.id
        left join `cmdb_resourcecenter_account_ip` crai on a.id = crai.`account_id`
        WHERE crai.`ip` IN
        <foreach collection="ipList" item="ip" open="(" close=")" separator=",">
            #{ip}
        </foreach>
    </select>
    <select id="getAccountTagListByAccountIdList" parameterType="java.util.List"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.AccountTagVo">
        SELECT
        `account_id` AS accountId,
        `tag_id` AS tagId
        FROM `cmdb_resourcecenter_account_tag`
        WHERE `account_id` in
        <foreach collection="list" item="accountId" open="(" separator="," close=")">
            #{accountId}
        </foreach>
    </select>

    <select id="checkAccountIsExists" resultType="int" parameterType="java.lang.Long">
        SELECT COUNT(1)
        FROM `cmdb_resourcecenter_account` a
        where a.`id` = #{value}
    </select>

    <select id="searchAccountProtocolListByProtocolName"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.AccountProtocolVo">
        select
        `id`,
        `name`,
        `port`
        from `cmdb_resourcecenter_account_protocol`
        <where>
            <if test="keyword != null and keyword != ''">
                `name` like concat('%', #{keyword}, '%')
                or
                `port` like concat('%', #{keyword}, '%')
            </if>
        </where>
        order by lcd desc
    </select>

    <select id="checkAccountProtocolIsRepeats" resultType="int"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.AccountProtocolVo">
        SELECT COUNT(1)
        FROM `cmdb_resourcecenter_account_protocol`
        WHERE `name` = #{name}
          and `port` = #{port}
          AND `id` != #{id}
    </select>

    <select id="checkAccountProtocolHasBeenReferredByProtocolId" parameterType="java.lang.Long" resultType="int">
        select count(1)
        from `cmdb_resourcecenter_account` a
        where a.protocol_id = #{value}
    </select>

    <select id="checkAccountProtocolIsExistsById" resultType="int" parameterType="java.lang.Long">
        select count(1)
        from `cmdb_resourcecenter_account_protocol`
        where `id` = #{value}
    </select>
    <select id="getAccountIp" resultType="codedriver.framework.cmdb.dto.resourcecenter.AccountIpVo">
        SELECT
        `account_id`,
        `ip`
        FROM
        `cmdb_resourcecenter_account_ip`
        <where>
            <if test="accountId != null">
                and `account_id` = #{accountId}
            </if>
            <if test="ip != null and ip != ''">
                and `ip` = #{ip}
            </if>
        </where>
    </select>
    <select id="getResourceAccountListByAccountId"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.ResourceAccountVo">
        SELECT `resource_id` AS resourceId,
               `account_id`  AS accountId
        FROM `cmdb_resourcecenter_resource_account`
        WHERE `account_id` = #{value}
    </select>

    <update id="updateAccount" parameterType="codedriver.framework.cmdb.dto.resourcecenter.AccountVo">
        update `cmdb_resourcecenter_account` a set
        a.`name` = #{name},
        a.`account` = #{account},
        <if test="passwordCipher != null">
            a.`password` = #{passwordCipher},
        </if>
        a.protocol_id = #{protocolId},
        a.`lcu` = #{lcu},
        a.`lcd` = now(3)
        where a.`id` = #{id}
    </update>

    <update id="updateTag" parameterType="codedriver.framework.cmdb.dto.tag.TagVo">
        update `cmdb_tag`
        set `name`        = #{name},
            `description` = #{description}
        where `id` = #{id}
    </update>

    <update id="updateAccountProtocol" parameterType="codedriver.framework.cmdb.dto.resourcecenter.AccountProtocolVo">
        update `cmdb_resourcecenter_account_protocol`
        set `name` = #{name},
            `port` = #{port},
            `lcd`  = now(3),
            `lcu`  = #{lcu}
        where `id` = #{id}
    </update>

    <insert id="replaceAccount" parameterType="codedriver.framework.cmdb.dto.resourcecenter.AccountVo">
        replace into `cmdb_resourcecenter_account` (
        `id`,
        `name`,
        `account`,
        <if test="passwordCipher != null">
            `password`,
        </if>
        `protocol_id` ,
        `lcu`,
        `lcd`,
        `fcu`,
        `fcd`
        )
        values (
        #{id},
        #{name},
        #{account},
        <if test="passwordCipher != null">
            #{passwordCipher},
        </if>
        #{protocolId},
        #{lcu},
        now(3),
        #{fcu},
        now(3)
        )
    </insert>

    <insert id="insertTag" parameterType="codedriver.framework.cmdb.dto.tag.TagVo">
        insert into `cmdb_tag` (`id`,
                                `name`,
                                `description`)
        values (#{id},
                #{name},
                #{description})
    </insert>

    <insert id="insertIgnoreResourceAccount"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceAccountVo">
        INSERT IGNORE INTO `cmdb_resourcecenter_resource_account` (`resource_id`, `account_id`) VALUES
        <foreach collection="list" item="resourceAccount" separator=",">
            (#{resourceAccount.resourceId}, #{resourceAccount.accountId})
        </foreach>
    </insert>

    <insert id="insertIgnoreResourceTag" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceTagVo">
        INSERT IGNORE INTO `cmdb_resourcecenter_resource_tag` (`resource_id`, `tag_id`) VALUES
        <foreach collection="list" item="resourceTag" separator=",">
            (#{resourceTag.resourceId}, #{resourceTag.tagId})
        </foreach>
    </insert>

    <insert id="insertIgnoreAccountTag" parameterType="codedriver.framework.cmdb.dto.resourcecenter.AccountTagVo">
        INSERT IGNORE INTO `cmdb_resourcecenter_account_tag` (`account_id`, `tag_id`) VALUES
        <foreach collection="list" item="accountTag" separator=",">
            (#{accountTag.accountId}, #{accountTag.tagId})
        </foreach>
    </insert>

    <insert id="insertAccountProtocol" parameterType="codedriver.framework.cmdb.dto.resourcecenter.AccountProtocolVo">
        insert into `cmdb_resourcecenter_account_protocol` (`id`, `name`, `port`, `fcd`, `fcu`, `lcd`, `lcu`)
        values (#{id}, #{name}, #{port}, now(3), #{fcu}, now(3), #{fcu})
    </insert>

    <insert id="insertIgnoreAccountIp">
        INSERT IGNORE INTO `cmdb_resourcecenter_account_ip` (`account_id`, `ip`)
        VALUES (#{accountId}, #{ip});
    </insert>

    <delete id="deleteAccountById" parameterType="java.lang.Long">
        delete
        from `cmdb_resourcecenter_account`
        where `id` = #{value}
    </delete>

    <delete id="deleteTagById" parameterType="java.lang.Long">
        delete
        from `cmdb_tag`
        where `id` = #{value}
    </delete>

    <delete id="deleteResourceAccountByResourceId" parameterType="java.lang.Long">
        DELETE
        FROM `cmdb_resourcecenter_resource_account`
        WHERE `resource_id` = #{value}
    </delete>

    <delete id="deleteResourceAccountByResourceIdListAndAccountIdList">
        DELETE FROM `cmdb_resourcecenter_resource_account`
        WHERE `resource_id` IN
        <foreach collection="resourceIdList" item="resourceId" open="(" separator="," close=")">
            #{resourceId}
        </foreach>
        AND `account_id` IN
        <foreach collection="accountIdList" item="accountId" open="(" separator="," close=")">
            #{accountId}
        </foreach>
    </delete>

    <delete id="deleteResourceTagByResourceId" parameterType="java.lang.Long">
        DELETE
        FROM `cmdb_resourcecenter_resource_tag`
        WHERE `resource_id` = #{value}
    </delete>

    <delete id="deleteResourceTagByResourceIdAndTagIdList">
        DELETE FROM `cmdb_resourcecenter_resource_tag`
        WHERE `resource_id` IN
        <foreach collection="resourceIdList" item="resourceId" open="(" separator="," close=")">
            #{resourceId}
        </foreach>
        AND `tag_id` IN
        <foreach collection="tagIdList" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
    </delete>

    <delete id="deleteAccountTagByAccountId" parameterType="java.lang.Long">
        DELETE
        FROM `cmdb_resourcecenter_account_tag`
        WHERE `account_id` = #{value}
    </delete>

    <delete id="deleteResourceAccountProtocolById">
        delete
        from `cmdb_resourcecenter_account_protocol`
        where `id` = #{value}
    </delete>
    <delete id="deleteAccountIpByAccountId" parameterType="java.lang.Long">
        DELETE
        FROM `cmdb_resourcecenter_account_ip`
        WHERE `account_id` = #{value}
    </delete>
    <delete id="deleteResourceAccountByAccountId">
        DELETE
        FROM `cmdb_resourcecenter_resource_account`
        WHERE `account_id` = #{value}
    </delete>
    <delete id="deleteAccountIpByIpList">
        DELETE
        FROM `cmdb_resourcecenter_account_ip`
        WHERE `ip` in
        <foreach collection="ipList" open="(" close=")" separator="," item="ip">
            #{ip}
        </foreach>
    </delete>

</mapper>
